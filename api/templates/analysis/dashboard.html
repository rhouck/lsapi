{% extends 'charts.html' %}


{% block title %}Dashboard{% endblock %}


{% block content %}
    <div class="row">
        <div class="col-md-6">

            <table class="table table-condensed">
    		<tr><td>Options Outstanding</td><td>{{ current_exposure.num_options_out }}</td><td>Cash Balance</td><td>{{ cash_balance.cash_balance }}</td></tr>
    		<tr><td>Expected Exposure</td><td>{{ current_exposure.current_exp_exposure }}</td><td>Additional Capacity</td><td>{{ additional_capacity.quantity }}</td></tr>
    		<tr><td>Next Expiration</td><td>{{ current_exposure.next_expiration }}</td><td>Last Change</td><td>{{ cash_balance.last_change }}</td></tr>
    		</table>
        </div>
        <div class="col-md-5">
            <div clas="row">
                <div class="col-md-12">
                    <form action="" method="post">
                        {% csrf_token %}
                        {% if sales_gate %}
                            <input type="submit" class="btn btn-success" name="change_status" value="Sales Open">
                        {% else %}
                            <input type="submit" class="btn btn-danger" name="change_status" value="Sales Closed">
                        {% endif %}

                    </form>
                </div>
            </div>
            <div clas="row">
                <div class="col-md-12">
                    <form class="form-inline" role="form" action="" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <input type="submit" class="btn btn-primary btn-sm" name="Search" value="Change Cash">
                            {% for field in form %}
                                <!--<label>{{ field.label_tag }}</label>-->
                                  {% for error in field.errors %} <p style="color: red;">{{ error }}</p>{% endfor %}
                                  {{ field }}
                            {% endfor %}

                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-11">
            <ul class="nav nav-tabs">
              <li class="active"><a href="#risk" data-toggle="tab" >Risk Exposure</a></li>
              <li><a href="#stats" data-toggle="tab" >Search/Purchase Statistics</a></li>
              <li><a href="#rec_act" data-toggle="tab" >Recent Activity</a></li>
            </ul>

            <div class="tab-content">
                <div id="risk" class="active tab-pane">
                    <div class="row">
                        <div class="col-md-6">
                	       <div id="cash_movement_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-6">
                           <div id="current_exposure_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div id="conversion_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-6">
                           <div id="avg_cash_effects_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                    </div>
                </div>

                <div id="stats" class="tab-pane">
                    <div class="row">
                        <div class="col-md-6">
                           <div id="conversion_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-6">
                           <div id="avg_cash_effects_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                    </div>

                    <div class="row">
                        <p>Why are these not showing?</p>
                        <div class="col-md-4">
                           <div id="search_flexibility_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-4">
                           <div id="search_hold_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-4">
                           <div id="search_dep_len_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                           <div id="purch_flexibility_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-4">
                           <div id="purch_hold_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                        <div class="col-md-4">
                           <div id="purch_dep_len_chart" style="height: 320px; min-width: 1px"></div>
                        </div>
                    </div>
                </div>

                <div id="rec_act" class="tab-pane">
                    <div class="row">
                        <div class="col-md-6">
                            <h3>Recent Purchases</h3>
                            <ul>
                            {% for contract in recent_purchases %}
                                <li>
                                {{contract.purch_date}}, {{contract.customer.last_name}}, {{contract.customer.first_name}}, {{contract.search.origin_code}}:{{contract.search.destination_code}}, Option fee: {{contract.search.holding_price}}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h3>Recent Exercises</h3>
                            <ul>
                            {% for contract in recent_exercises %}
                                <li>
                                {{contract.ex_date}}, {{contract.customer.last_name}}, {{contract.customer.first_name}}, {{contract.search.origin_code}}:{{contract.search.destination_code}}, Exercise fare: {{contract.ex_fare}}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


{% endblock %}


{% block charts %}

    <script>
    // cash movement graph
    var cash_movement_series = {{ cash_movement|safe }};
    $(function () {

            window.chart = new Highcharts.StockChart({

                chart: {
                    renderTo: 'cash_movement_chart',
                    type: 'area'
                },

                rangeSelector: {
                    selected: 2
                },

                title: {
                    text: 'Risk Pool Cash Balance'
                },

                series: cash_movement_series,



                });
    });

    // current exposure graph
    var exposure_outlook_series = {{ exposure_outlook|safe }};
    $(function () {

            window.chart = new Highcharts.StockChart({

                chart: {
                    renderTo: 'current_exposure_chart',
                    type: 'area'
                },

                rangeSelector: {
                    selected: 2
                },

                title: {
                    text: 'Current Expected Exposure',
                },

                series: exposure_outlook_series,

                plotOptions: {
                    series: {
                        dataLabels: {
                            enabled: true,
                            formatter: function() {
                                return this.point.count;
                            }
                        }
                    },
                },


                });
    });

    // conversion graph
    var conversion_series = {{ conversion|safe }};
    $(function () {

            window.chart = new Highcharts.StockChart({

                chart: {
                    renderTo: 'conversion_chart',
                    type: 'area'
                },

                rangeSelector: {
                    selected: 2
                },

                title: {
                    text: 'Search conversion over time'
                },

                series: conversion_series,


                });
    });

    // average cash effects graph
    var average_cash_effects_series = {{ average_cash_effects|safe }};
    $(function () {

            window.chart = new Highcharts.StockChart({

                chart: {
                    renderTo: 'avg_cash_effects_chart',

                },

                rangeSelector: {
                    selected: 2
                },

                title: {
                    text: 'Average ultimate cash effects per purchased option'
                },

                series: average_cash_effects_series,


                });
    });

    // search flexibility pie
    var search_flex_data = {{ search_flex_chart|safe }};
    $(function () {

            window.chart = new Highcharts.Chart({

                chart: {
                    renderTo: 'search_flexibility_chart',
                    type: 'pie'
                },

                title: {
                    text: 'Flexibility preference in searches'
                },

                series: [{
                    type: 'pie',
                    data: search_flex_data
                }],
                tooltip: {
                    pointFormat: '{point.percentage}%',
                    percentageDecimals: 1
                }

                });
    });

    // search hold period pie
    var search_hold_data = {{ search_hold_chart|safe }};
    $(function () {

            window.chart = new Highcharts.Chart({

                chart: {
                    renderTo: 'search_hold_chart',
                    type: 'pie'
                },

                title: {
                    text: 'Holding period preference in searches'
                },

                series: [{
                    type: 'pie',
                    data: search_hold_data
                }],
                tooltip: {
                    pointFormat: '{point.percentage}%',
                    percentageDecimals: 1
                }
                });
    });
    // search time to departure pie
    var search_dep_len_data = {{ search_dep_len_chart|safe }};
    $(function () {

            window.chart = new Highcharts.Chart({

                chart: {
                    renderTo: 'search_dep_len_chart',
                    type: 'pie'
                },

                title: {
                    text: 'Number weeks between search and departure'
                },

                series: [{
                    type: 'pie',
                    data: search_dep_len_data
                }],
                tooltip: {
                    pointFormat: '{point.percentage}%',
                    percentageDecimals: 1
                }
                });
    });
    // purchase flexibility pie
    var purch_flex_data = {{ purch_flex_chart|safe }};
    $(function () {

            window.chart = new Highcharts.Chart({

                chart: {
                    renderTo: 'purch_flexibility_chart',
                    type: 'pie'
                },

                title: {
                    text: 'Flexibility preference in purchases'
                },

                series: [{
                    type: 'pie',
                    data: purch_flex_data
                }],
                tooltip: {
                    pointFormat: '{point.percentage}%',
                    percentageDecimals: 1
                }
                });
    });

    // purchase hold period pie
    var purch_hold_data = {{ purch_hold_chart|safe }};
    $(function () {

            window.chart = new Highcharts.Chart({

                chart: {
                    renderTo: 'purch_hold_chart',
                    type: 'pie'
                },

                title: {
                    text: 'Holding period preference in purchases'
                },

                series: [{
                    type: 'pie',
                    data: purch_hold_data
                }],
                tooltip: {
                    pointFormat: '{point.percentage}%',
                    percentageDecimals: 1
                }
                });
    });
    // purchase time to departure pie
    var purch_dep_len_data = {{ purch_dep_len_chart|safe }};
    $(function () {

            window.chart = new Highcharts.Chart({

                chart: {
                    renderTo: 'purch_dep_len_chart',
                    type: 'pie'
                },

                title: {
                    text: 'Number weeks between purchase and departure'
                },

                series: [{
                    type: 'pie',
                    data: purch_dep_len_data
                }],
                tooltip: {
                    pointFormat: '{point.percentage}%',
                    percentageDecimals: 1
                }
                });
    });

    </script>
{% endblock %}

